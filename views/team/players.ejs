<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Available Players</h2>
  <div>
    <div class="input-group">
      <input type="text" class="form-control" id="playerSearch" placeholder="Search players...">
      <button class="btn btn-outline-secondary" type="button">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </div>
</div>

<div class="row">
  <% players.forEach(player => { %>
    <div class="col-md-4 mb-4 player-item" data-player-name="<%= player.name %>" data-player-role="<%= player.role %>">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5><%= player.name %></h5>
          <small><%= player.role %></small>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <img src="<%= player.image %>" alt="<%= player.name %>" class="img-fluid rounded" style="max-height: 150px;">
          </div>
          <div class="row mb-2">
            <div class="col-6">
              <strong>Base Price:</strong>
            </div>
            <div class="col-6 text-end">
              ₹<%= player.basePrice.toLocaleString() %>
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-6">
              <strong>Matches:</strong>
            </div>
            <div class="col-6 text-end">
              <%= player.stats.matches %>
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-6">
              <strong>Runs:</strong>
            </div>
            <div class="col-6 text-end">
              <%= player.stats.runs %>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-6">
              <strong>Wickets:</strong>
            </div>
            <div class="col-6 text-end">
              <%= player.stats.wickets %>
            </div>
          </div>
          <div class="d-grid">
            <button class="btn btn-warning bid-btn" data-player-id="<%= player._id %>">
              <i class="bi bi-hammer"></i> Bid for Player
            </button>
          </div>
        </div>
      </div>
    </div>
  <% }); %>
</div>

<!-- Bid Modal -->
<div class="modal fade" id="bidModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Place Your Bid</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="bidForm">
          <input type="hidden" id="playerId" name="playerId">
          <input type="hidden" id="teamId" name="teamId" value="<%= team._id %>">
          
          <div class="mb-3">
            <label for="playerName" class="form-label">Player</label>
            <input type="text" class="form-control" id="playerName" readonly>
          </div>
          
          <div class="mb-3">
            <label for="currentBid" class="form-label">Current Bid</label>
            <input type="text" class="form-control" id="currentBid" readonly>
          </div>
          
          <div class="mb-3">
            <label for="bidAmount" class="form-label">Your Bid (₹)</label>
            <input type="number" class="form-control" id="bidAmount" name="amount" required>
            <div class="form-text">Minimum bid: ₹<span id="minBid">0</span></div>
          </div>
          
          <div class="mb-3">
            <label for="teamBudget" class="form-label">Your Budget</label>
            <input type="text" class="form-control" id="teamBudget" value="₹<%= team.budget.toLocaleString() %>" readonly>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="submitBid">Place Bid</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    
    // Join auction room
    socket.emit('joinAuction');
    
    // Listen for new bids
    socket.on('newBid', function(data) {
      // Update UI if this player is being viewed
      if (document.getElementById('playerId').value === data.playerId) {
        document.getElementById('currentBid').value = `₹${data.amount.toLocaleString()}`;
        document.getElementById('minBid').textContent = (data.amount + 50000).toLocaleString();
        document.getElementById('bidAmount').min = data.amount + 50000;
      }
    });
    
    // Player search
    document.getElementById('playerSearch').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      document.querySelectorAll('.player-item').forEach(item => {
        const playerName = item.getAttribute('data-player-name').toLowerCase();
        const playerRole = item.getAttribute('data-player-role').toLowerCase();
        if (playerName.includes(searchTerm) || playerRole.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Bid buttons
    document.querySelectorAll('.bid-btn').forEach(button => {
      button.addEventListener('click', function() {
        const playerId = this.getAttribute('data-player-id');
        const playerCard = this.closest('.card');
        const playerName = playerCard.querySelector('.card-header h5').textContent;
        const playerRole = playerCard.querySelector('.card-header small').textContent;
        const basePrice = playerCard.querySelector('.row:nth-child(1) .col-6.text-end').textContent.replace('₹', '').replace(',', '');
        
        // Populate modal
        document.getElementById('playerId').value = playerId;
        document.getElementById('playerName').value = `${playerName} (${playerRole})`;
        document.getElementById('currentBid').value = `₹${parseInt(basePrice).toLocaleString()}`;
        document.getElementById('minBid').textContent = (parseInt(basePrice) + 50000).toLocaleString();
        document.getElementById('bidAmount').min = parseInt(basePrice) + 50000;
        document.getElementById('bidAmount').value = parseInt(basePrice) + 50000;
        
        // Show modal
        const bidModal = new bootstrap.Modal(document.getElementById('bidModal'));
        bidModal.show();
      });
    });
    
    // Submit bid
    document.getElementById('submitBid').addEventListener('click', function() {
      const playerId = document.getElementById('playerId').value;
      const teamId = document.getElementById('teamId').value;
      const amount = parseInt(document.getElementById('bidAmount').value);
      
      fetch('/api/bid', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ playerId, teamId, amount })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Emit bid event
          socket.emit('placeBid', {
            playerId,
            amount: data.currentBid
          });
          
          // Close modal
          const bidModal = bootstrap.Modal.getInstance(document.getElementById('bidModal'));
          bidModal.hide();
          
          // Show success message
          alert('Bid placed successfully!');
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to place bid. Please try again.');
      });
    });
  });
</script>