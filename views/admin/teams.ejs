<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold text-primary"><i class="bi bi-people-fill me-2"></i>Teams Management</h2>
  <a href="/admin/teams/add" class="btn btn-primary btn-lg">
    <i class="bi bi-plus-circle"></i> Add Team
  </a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Logo</th>
            <th>Team Name</th>
            <th>Owner</th>
            <th>Budget</th>
            <th>Players</th>
            <th>User</th>
            <th style="width: 160px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% teams.forEach(team => { %>
            <tr>
              <td>
                <img src="<%= team.logo %>" alt="<%= team.name %>" class="img-thumbnail" style="max-width: 50px;">
              </td>
              <td class="fw-bold"><%= team.name %></td>
              <td><%= team.owner %></td>
              <td>₹<%= team.budget.toLocaleString() %></td>
              <td><span class="badge bg-info text-dark"><%= team.players.length %></span></td>
              <td><%= team.user ? team.user.username : '-' %></td>
              <td>
                <div class="d-flex gap-2">
                  <a href="/admin/teams/<%= team._id %>" class="btn btn-outline-info btn-sm" title="View Team">
                    <i class="bi bi-eye"></i> View Team
                  </a>
                  <button class="btn btn-outline-warning btn-sm edit-team-btn" data-team='<%- JSON.stringify(team) %>' title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-team-btn" data-id="<%= team._id %>" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- View/Edit Modal -->
<div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="teamModalLabel">Team Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
  <form id="editTeamForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label">Team Name</label>
            <input type="text" class="form-control" id="teamName" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Owner</label>
            <input type="text" class="form-control" id="teamOwner" name="owner" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Budget</label>
            <input type="number" class="form-control" id="teamBudget" name="budget" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Logo</label>
            <input type="file" class="form-control" id="teamLogoFile" name="logo" accept="image/*">
            <small class="text-muted">Upload a new image to change the logo.</small>
            <input type="hidden" class="form-control" id="teamLogo" name="logo">
          </div>
          <input type="hidden" id="teamId" name="_id">
        </form>
        <div id="viewTeamDetails" style="display:none">
          <p><strong>Team Name:</strong> <span id="viewTeamName"></span></p>
          <p><strong>Owner:</strong> <span id="viewTeamOwner"></span></p>
          <p><strong>Budget:</strong> ₹<span id="viewTeamBudget"></span></p>
          <p><strong>Logo:</strong> <img id="viewTeamLogo" src="" alt="Logo" style="max-width: 60px;"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary" id="saveTeamBtn" style="display:none">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const teamModal = new bootstrap.Modal(document.getElementById('teamModal'));
  const editForm = document.getElementById('editTeamForm');
  const viewDetails = document.getElementById('viewTeamDetails');
  const saveBtn = document.getElementById('saveTeamBtn');

  // View team
  document.querySelectorAll('.view-team-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const team = JSON.parse(this.dataset.team);
      document.getElementById('teamModalLabel').textContent = 'Team Details';
      editForm.style.display = 'none';
      viewDetails.style.display = 'block';
      saveBtn.style.display = 'none';
      document.getElementById('viewTeamName').textContent = team.name;
      document.getElementById('viewTeamOwner').textContent = team.owner;
      document.getElementById('viewTeamBudget').textContent = team.budget.toLocaleString();
      document.getElementById('viewTeamLogo').src = team.logo;
      teamModal.show();
    });
  });

  // Edit team
  document.querySelectorAll('.edit-team-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const team = JSON.parse(this.dataset.team);
      document.getElementById('teamModalLabel').textContent = 'Edit Team';
      editForm.style.display = 'block';
      viewDetails.style.display = 'none';
      saveBtn.style.display = 'inline-block';
      document.getElementById('teamName').value = team.name;
      document.getElementById('teamOwner').value = team.owner;
      document.getElementById('teamBudget').value = team.budget;
      document.getElementById('teamLogo').value = team.logo;
      document.getElementById('teamId').value = team._id;
      teamModal.show();
    });
  });

  // Save team changes
  saveBtn.addEventListener('click', function() {
    const formData = new FormData(editForm);
    fetch(`/admin/teams/edit/${formData.get('_id')}`, {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error updating team');
      }
    });
  });

  // Delete team
  document.querySelectorAll('.delete-team-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const teamId = this.dataset.id;
      if (confirm('Are you sure you want to delete this team?')) {
        fetch(`/admin/teams/delete/${teamId}`, {
          method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error deleting team');
          }
        });
      }
    });
  });
});
</script>